<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIèŠå¤©åŠ©æ‰‹</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-robot"></i> AIèŠå¤©åŠ©æ‰‹</h1>
            <div class="model-info">
                <span id="modelName">æ­£åœ¨åŠ è½½æ¨¡å‹ä¿¡æ¯...</span>
                <button id="clearChat" class="btn-clear">
                    <i class="fas fa-trash-alt"></i> æ¸…ç©ºèŠå¤©
                </button>
            </div>
        </header>

        <div class="chat-container">
            <div class="chat-history" id="chatHistory">
                <!-- èŠå¤©æ¶ˆæ¯ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                <div class="welcome-message">
                    <p>ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ</p>
                </div>
            </div>

            <div class="input-area">
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea 
                            id="messageInput" 
                            placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯..." 
                            rows="3"
                            onkeydown="handleKeyPress(event)"
                        ></textarea>
                        
                        <!-- æ–‡ä»¶åˆ—è¡¨ - æ˜¾ç¤ºå·²é€‰æ‹©çš„æ–‡ä»¶ -->
                        <div class="file-list-container" id="fileListContainer" style="display: none;">
                            <div class="file-list-header">
                                <span>å·²é€‰æ‹©æ–‡ä»¶:</span>
                                <button class="clear-files-btn" onclick="clearFileList()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="file-list" id="fileList"></div>
                        </div>
                    </div>
                    
                    <div class="input-actions">
                        <div class="config-info">
                            <span class="config-item">
                                <i class="fas fa-brain"></i>
                                <span id="currentModel">-</span>
                            </span>
                            <span class="config-item">
                                <i class="fas fa-thermometer-half"></i>
                                <span id="currentTemp">{{ '%.1f'|format(config.temperature|default(0.7)) }}</span>
                            </span>
                        </div>
                        <div class="input-buttons">
                            <!-- ç®€æ´çš„æ–‡ä»¶ä¸Šä¼ æŒ‰é’® -->
                            <div class="file-upload-btn-container">
                                <input type="file" id="fileInput" multiple style="display: none;">
                                <button id="uploadButton" class="btn-attach" title="ä¸Šä¼ æ–‡ä»¶">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <div class="file-count-badge" id="fileCountBadge" style="display: none;">0</div>
                            </div>
                            <button id="sendButton" class="btn-send">
                                <i class="fas fa-paper-plane"></i> å‘é€
                            </button>
                        </div>
                    </div>
                </div>
                <div class="input-hint">
                    <small>æŒ‰ Enter å‘é€ï¼ŒShift + Enter æ¢è¡Œ â€¢ æ”¯æŒä¸Šä¼ æ–‡æœ¬ã€PDFã€å›¾ç‰‡ç­‰æ–‡ä»¶</small>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>Powered by Flask & LLM API | æ”¯æŒæµå¼å“åº”å’Œæ–‡ä»¶ä¸Šä¼ </p>
        </footer>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let chatHistory = [];
        let currentStream = null;
        let uploadedFiles = [];

        // DOM å…ƒç´ 
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const uploadButton = document.getElementById('uploadButton');
        const chatHistoryEl = document.getElementById('chatHistory');
        const clearChatBtn = document.getElementById('clearChat');
        const modelNameEl = document.getElementById('modelName');
        const currentModelEl = document.getElementById('currentModel');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const fileListContainer = document.getElementById('fileListContainer');
        const fileCountBadge = document.getElementById('fileCountBadge');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            setupEventListeners();
            messageInput.focus();
        });

        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                const response = await fetch('/config');
                const config = await response.json();
                
                modelNameEl.textContent = `æ¨¡å‹: ${config.model}`;
                currentModelEl.textContent = config.model;
                
                if (!config.has_api_key) {
                    showError('æœªé…ç½®APIå¯†é’¥ï¼Œè¯·æ£€æŸ¥é…ç½®');
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            sendButton.addEventListener('click', sendMessage);
            clearChatBtn.addEventListener('click', clearChat);
            uploadButton.addEventListener('click', () => fileInput.click());
            
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', handleFileSelect);
            
            // è¾“å…¥æ¡†è‡ªåŠ¨è°ƒæ•´é«˜åº¦
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(e) {
            const files = e.target.files;
            processFiles(files);
        }

        // å¤„ç†æ–‡ä»¶
        function processFiles(files) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = [
                'image/jpeg', 'image/png', 'image/gif',
                'application/pdf',
                'text/plain', 'text/markdown', 'text/html',
                'application/msword', 
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
            ];
            
            let addedFiles = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // æ£€æŸ¥æ–‡ä»¶å¤§å°
                if (file.size > maxSize) {
                    showError(`æ–‡ä»¶ ${file.name} è¶…è¿‡10MBé™åˆ¶`);
                    continue;
                }
                
                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                if (!allowedTypes.includes(file.type) && !file.name.match(/\.(txt|md|pdf|doc|docx|jpg|jpeg|png|gif)$/i)) {
                    showError(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${file.name}`);
                    continue;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåæ–‡ä»¶
                const existingFile = uploadedFiles.find(f => f.name === file.name && f.size === file.size);
                if (existingFile) {
                    showError(`æ–‡ä»¶ ${file.name} å·²æ·»åŠ `);
                    continue;
                }
                
                // æ·»åŠ åˆ°ä¸Šä¼ åˆ—è¡¨
                addFileToList(file);
                uploadedFiles.push(file);
                addedFiles++;
            }
            
            if (addedFiles > 0) {
                updateFileListDisplay();
                showSuccess(`å·²æ·»åŠ  ${addedFiles} ä¸ªæ–‡ä»¶`);
            }
            
            fileInput.value = ''; // é‡ç½®inputä»¥ä¾¿é‡æ–°é€‰æ‹©ç›¸åŒæ–‡ä»¶
        }

        // æ·»åŠ æ–‡ä»¶åˆ°åˆ—è¡¨
        function addFileToList(file) {
            const fileId = 'file-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            file.fileId = fileId;
            
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.id = fileId;
            fileItem.innerHTML = `
                <div class="file-info">
                    <i class="fas ${getFileIcon(file.type, file.name)}"></i>
                    <div class="file-details">
                        <span class="file-name">${file.name}</span>
                        <span class="file-size">${formatFileSize(file.size)}</span>
                    </div>
                </div>
                <button class="file-remove" onclick="removeFile('${fileId}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            fileList.appendChild(fileItem);
        }

        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(type, name) {
            if (type.startsWith('image/')) return 'fa-image';
            if (type === 'application/pdf') return 'fa-file-pdf';
            if (type.startsWith('text/')) return 'fa-file-alt';
            if (name.match(/\.docx?$/i)) return 'fa-file-word';
            if (name.match(/\.xlsx?$/i)) return 'fa-file-excel';
            return 'fa-file';
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ç§»é™¤æ–‡ä»¶
        function removeFile(fileId) {
            // ä»ç•Œé¢ç§»é™¤
            const fileElement = document.getElementById(fileId);
            if (fileElement) {
                fileElement.remove();
            }
            
            // ä»æ•°ç»„ç§»é™¤
            uploadedFiles = uploadedFiles.filter(file => file.fileId !== fileId);
            updateFileListDisplay();
        }

        // æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
        function updateFileListDisplay() {
            if (uploadedFiles.length > 0) {
                fileListContainer.style.display = 'block';
                fileCountBadge.textContent = uploadedFiles.length;
                fileCountBadge.style.display = 'block';
            } else {
                fileListContainer.style.display = 'none';
                fileCountBadge.style.display = 'none';
            }
            
            // è°ƒæ•´æ–‡æœ¬åŒºåŸŸè¾¹è·
            if (uploadedFiles.length > 0) {
                messageInput.style.marginBottom = '10px';
            } else {
                messageInput.style.marginBottom = '0';
            }
        }

        // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
        function clearFileList() {
            if (uploadedFiles.length > 0) {
                if (confirm(`ç¡®å®šè¦ç§»é™¤ ${uploadedFiles.length} ä¸ªæ–‡ä»¶å—ï¼Ÿ`)) {
                    fileList.innerHTML = '';
                    uploadedFiles = [];
                    updateFileListDisplay();
                }
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const message = messageInput.value.trim();
            
            // å¦‚æœæ²¡æœ‰æ¶ˆæ¯å’Œæ–‡ä»¶ï¼Œç›´æ¥è¿”å›
            if (!message && uploadedFiles.length === 0) {
                showError('è¯·è¾“å…¥æ¶ˆæ¯æˆ–ä¸Šä¼ æ–‡ä»¶');
                return;
            }
            
            // ç¦ç”¨è¾“å…¥å’Œå‘é€æŒ‰é’®
            messageInput.disabled = true;
            sendButton.disabled = true;
            uploadButton.disabled = true;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ€è€ƒä¸­...';
            
            // å¦‚æœæœ‰æ–‡ä»¶ï¼Œå…ˆä¸Šä¼ æ–‡ä»¶
            let fileContents = [];
            if (uploadedFiles.length > 0) {
                try {
                    fileContents = await uploadFiles();
                } catch (error) {
                    console.error('ä¸Šä¼ æ–‡ä»¶å¤±è´¥:', error);
                    showError('æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                    resetInputState();
                    return;
                }
            }
            
            // æ„å»ºå®Œæ•´æ¶ˆæ¯
            let fullMessage = message;
            if (fileContents.length > 0) {
                fullMessage += '\n\nä¸Šä¼ çš„æ–‡ä»¶å†…å®¹:\n' + fileContents.join('\n\n---\n\n');
            }
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
            addMessageToUI('user', fullMessage);
            
            // æ¸…ç©ºè¾“å…¥æ¡†å’Œæ–‡ä»¶åˆ—è¡¨
            messageInput.value = '';
            messageInput.style.height = 'auto';
            clearFileList();
            
            // æ·»åŠ AIæ¶ˆæ¯å ä½ç¬¦
            const aiMessageId = 'ai-' + Date.now();
            addMessageToUI('ai', '', aiMessageId);
            
            // å‘é€è¯·æ±‚
            try {
                currentStream = await streamAIResponse(fullMessage, aiMessageId);
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                updateAIMessage(aiMessageId, `<span class="error">è¯·æ±‚å¤±è´¥: ${error.message}</span>`);
            } finally {
                resetInputState();
            }
        }

        // ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨
        async function uploadFiles() {
            const fileContents = [];
            
            for (let i = 0; i < uploadedFiles.length; i++) {
                const file = uploadedFiles[i];
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`æ–‡ä»¶ ${file.name} ä¸Šä¼ å¤±è´¥`);
                }
                
                const result = await response.json();
                if (result.success) {
                    fileContents.push(`æ–‡ä»¶: ${file.name}\n${result.content}`);
                }
                
                // æ›´æ–°è¿›åº¦æç¤º
                showProgress(`æ­£åœ¨å¤„ç†æ–‡ä»¶ (${i + 1}/${uploadedFiles.length})...`);
            }
            
            return fileContents;
        }

        // é‡ç½®è¾“å…¥çŠ¶æ€
        function resetInputState() {
            messageInput.disabled = false;
            sendButton.disabled = false;
            uploadButton.disabled = false;
            sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> å‘é€';
            messageInput.focus();
        }

        // æµå¼è·å–AIå“åº”
        async function streamAIResponse(userMessage, messageId) {
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²
            chatHistory.push({ role: 'user', content: userMessage });
            
            // å‘èµ·æµå¼è¯·æ±‚
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: userMessage,
                    history: chatHistory.slice(-10) // å‘é€æœ€è¿‘10æ¡å†å²
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯: ${response.status}`);
            }
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let aiResponse = '';
            
            // è¯»å–æµæ•°æ®
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.substring(6);
                        
                        if (data === '[DONE]') {
                            // æµå¼ä¼ è¾“å®Œæˆ
                            chatHistory.push({ role: 'assistant', content: aiResponse });
                            return;
                        }
                        
                        try {
                            const parsed = JSON.parse(data);
                            
                            if (parsed.error) {
                                throw new Error(parsed.error);
                            }
                            
                            if (parsed.content) {
                                aiResponse += parsed.content;
                                updateAIMessage(messageId, aiResponse);
                            }
                        } catch (e) {
                            console.error('è§£ææµæ•°æ®å¤±è´¥:', e);
                        }
                    }
                }
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addMessageToUI(role, content, messageId = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;

            if (messageId) {
                messageDiv.id = messageId;
            }

            // ç»Ÿä¸€ç»“æ„ï¼šå›¾æ ‡éƒ½åœ¨æ¶ˆæ¯å‰é¢ï¼Œåªæ˜¯é¡ºåºä¸åŒ
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="${role === 'user' ? 'fas fa-user' : 'fas fa-robot'}"></i>
                </div>
                <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
            `;

            chatHistoryEl.appendChild(messageDiv);
            scrollToBottom();
        }

        // æ›´æ–°AIæ¶ˆæ¯
        function updateAIMessage(messageId, content) {
            const messageDiv = document.getElementById(messageId);
            if (messageDiv) {
                const contentDiv = messageDiv.querySelector('.message-content');
                contentDiv.innerHTML = content.replace(/\n/g, '<br>');
                scrollToBottom();
            }
        }

        // æ¸…ç©ºèŠå¤©
        function clearChat() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºèŠå¤©è®°å½•å—ï¼Ÿ')) {
                // ä¸­æ­¢å½“å‰æµ
                if (currentStream) {
                    currentStream.cancel?.();
                }
                
                // æ¸…ç©ºå†å²
                chatHistory = [];
                clearFileList();
                
                // æ¸…ç©ºç•Œé¢ï¼ˆä¿ç•™æ¬¢è¿æ¶ˆæ¯ï¼‰
                const welcomeMessage = document.querySelector('.welcome-message');
                chatHistoryEl.innerHTML = '';
                if (welcomeMessage) {
                    chatHistoryEl.appendChild(welcomeMessage);
                }
                
                scrollToBottom();
            }
        }

        // å¤„ç†é”®ç›˜å¿«æ·é”®
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            chatHistoryEl.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            chatHistoryEl.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        // æ˜¾ç¤ºè¿›åº¦æ¶ˆæ¯
        function showProgress(message) {
            // å¦‚æœæœ‰æ—§çš„è¿›åº¦æ¶ˆæ¯ï¼Œå…ˆç§»é™¤
            const oldProgress = document.querySelector('.progress-message');
            if (oldProgress) oldProgress.remove();
            
            const progressDiv = document.createElement('div');
            progressDiv.className = 'progress-message';
            progressDiv.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${message}`;
            chatHistoryEl.appendChild(progressDiv);
            scrollToBottom();
            
            // 5ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (progressDiv.parentNode) {
                    progressDiv.remove();
                }
            }, 5000);
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        }
    </script>
</body>
</html>