#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# Copyright (c) [2025] [liuyngchng@hotmail.com] - All rights reserved.
import os
import logging.config

from apps.paper_review.paper_reviewer import PaperReviewer
from common.sys_init import init_yml_cfg


log_config_path = 'logging.conf'
if os.path.exists(log_config_path):
    logging.config.fileConfig(log_config_path, encoding="utf-8")
else:
    from common.const import LOG_FORMATTER
    logging.basicConfig(level=logging.INFO,format= LOG_FORMATTER, force=True)
logger = logging.getLogger(__name__)

def test_fill_formatted_html_report():

    single_report = """
# 【 安全网络可研报告 】 评审报告
 ## 评审概述
 - 评审时间: 2025-12-24 15:38:28

 - - 整体评分: 78/100

 - - 评审结论: 通过
## 整体评价
整体来看，该安全网络可行性研究报告在结构上较为完整，涵盖了项目的关键方面。然而，在术语定义、编制依据、项目交流情况、项目背景、业务及系统存在的问题以及预期目标等方面存在一定的不足。报告需要进一步完善术语定义，增加具体的数据和实例支撑，细化预期目标，并提供具体的技术解决方案。此外，还需明确编制依据与项目之间的关联性，确保论证的连贯性和一致性。总体而言，报告具有一定的参考价值，但需进一步改进以提高其科学性和实用性。
### 主要优势
- 报告结构较为完整，涵盖了项目概述、背景、业务及系统问题以及预期目标等关键部分。
- 对政策和技术规范的引用较为全面，为项目的立项提供了基础依据。
### 主要问题
- 术语定义和编制依据部分存在一些关键术语未明确解释的情况，可能影响读者的理解。
- 项目交流情况中的会议记录缺乏具体数据支持，难以评估其对项目立项的实际指导意义。
- 在项目背景、业务及系统存在的问题以及预期目标章节中，缺乏具体的数据或实例支撑，使得分析显得不够具体和有力。
- 部分概念如“智慧感控”、“全生命周期管理”等未作详细解释，可能导致非专业读者理解困难。
- 对于GIS图档不支持数据共享的问题没有提供具体的解决方案或替代方案
- 预期目标描述较为笼统，缺乏具体的数据支持和详细的实施步骤，可实现性不够明确。
### 关键建议
- 补充和完善术语定义部分，确保所有关键术语都有明确的解释。
- 在编制依据部分标注引用文件的具体版本号或发布日期，并明确说明这些依据如何具体支撑本项目的立项和建设。
- 在项目交流情况部分增加具体的数据支持，总结每次会议成果并分析其对项目立项及后续工作的实际指导意义。
- 在项目背景、业务及系统存在的问题以及预期目标章节中，增加具体的数据或实例支撑，使分析更加具体和有力。
- 详细解释“智慧感控”、“全生命周期管理”等概念，以便非专业读者更好地理解。
- 针对GIS图档不支持数据共享的问题，提供具体的解决方案或替代方案。
- 细化预期目标，提供具体的数据支持和详细的实施步骤，以增强目标的可实现性。

## 各章节评审结果

### 概述->术语定义
- **评分**: 80/100
- **风险等级**: 低
#### 优
- 术语定义清晰，涵盖了项目中涉及的主要概念和技术。
- 智慧化运维和智能模型的定义较为详细，能够帮助读者理解相关技术的应用场景。
#### 问题
- 术语定义部分缺少对一些关键术语的具体解释，如'合同'、'乙方'等，可能造成理解上的歧义。
- 未提供具体的技术文档或资料样本，使得对技术文档的理解不够直观。
- 智慧决策的定义较为简略，未能充分说明其在实际操作中的应用方式及重要性。
#### 改进建议
- 补充对'合同'、'乙方'等相关术语的明确定义，以减少理解上的歧义。
- 增加技术文档或资料的示例，使读者能够更直观地了解技术文档的内容和格式。
- 进一步细化智慧决策的定义，结合实际案例说明其在项目中的具体应用及其重要性。
### 概述->编制依据
- **评分**: 80/100
- **风险等级**: 中
#### 优点
- 报告中引用了大量国家政策、地方政策、行业规范及技术规范，显示了对项目背景和依据的全面考虑。
- 涵盖了从国家到地方再到具体行业的多层级政策支持，增强了项目的合法性和可行性。
- 引用的技术规范详细且全面，为项目的实施提供了坚实的技术基础。
#### 问题
- 缺少对引用文件的具体版本号或发布日期的标注，可能影响文件的有效性和适用性。
- 虽然列出了多项政策和技术规范，但未明确说明这些依据如何具体支撑本项目的立项和建设，缺乏直接关联性。
- 在编制依据部分没有提及任何国际标准或最佳实践，可能会限制项目的国际化视野和技术先进性。
#### 改进建议
- 建议补充每项引用文件的具体版本号和发布日期，确保文件的有效性和最新性。
- 增加对每个政策和规范与项目具体需求之间的关联性分析，明确其对项目的支持作用。
- 考虑引入一些国际标准或行业最佳实践，以提升项目的整体技术水平和国际竞争力。
### 概述->项目交流情况
- **评分**: 73/100\n- **风险等级**: 中
#### 优点
- 项目交流情况详细记录了多次会议的时间、地点、参与人员及讨论内容，有助于后续工作的追溯。
- 每次会议都有明确的交流主题和具体的会议内容，体现了项目的系统性和条理性。
- 详细记录了多次项目交流的时间、地点和参与人员，有助于追溯项目的讨论过程。
- 涵盖了与外部厂家及集团内部多个部门的交流情况，体现了多方面的意见和建议。
- 章节中详细记录了项目交流的具体日期、参与方及讨论内容，有助于后续跟踪和参考。
#### 问题
- 部分会议记录中缺乏具体的数据支持，如第1次会议仅提到“智慧城市指挥中心调研”，但未提供调研的具体成果或数据。\n  - 缺少对每次会议成果的总结与分析，难以评估这些交流是否对项目立项及后续工作有实际指导意义。
- 日期格式不一致（如2024年5月15日和2025年1月10号），建议统一使用YYYY-MM-DD格式以提高文档的专业性。
- 缺少对每次交流的具体成果总结，无法直接看出这些交流对项目立项及后续工作的实际指导意义。
- 部分会议内容描述较为简略，例如“汇报生产运维模式调整方案”等，缺乏具体细节，难以评估其价值。
- 没有明确指出在这些交流中发现的问题或挑战，以及如何解决这些问题，使得报告显得不够全面。
- 缺乏对每次会议成果的总结或结论，难以评估这些交流是否对项目立项及后续工作有实际指导意义。
- 未提供具体的用户需求描述，仅提到“用户需求整体介绍”，但具体内容缺失，无法判断其完整性和准确性。
- 没有提及任何数据支持或实例来说明为何需要进行这些讨论，使得论证显得不够充分有力。
- 缺少对交流过程中发现的问题及其解决方案的描述，不利于风险管理和后续改进。
#### 改进建议
- 在每次会议记录后增加一个简短的总结部分，概述会议的主要成果及其对项目的影响，以便更好地体现交流的实际价值。
- 尽可能地为每次会议的内容添加更多具体的数据或实例支持，增强报告的说服力。
- 统一文档中的日期格式，建议采用国际标准的YYYY-MM-DD格式，以提升报告的专业性和一致性。
- 为每次交流添加一个简短的成果总结部分，说明该次交流对项目推进的具体贡献。
- 增加对会议内容的详细描述，特别是涉及关键决策和技术方案的部分，以便更好地理解其重要性。
### 项目背景->项目背景
- **评分**: 80/100
- **风险等级**: 中
#### 优点
- 报告详细引用了多项政策法规，充分展示了项目实施的政策背景和必要性。
- 明确了集团业务战略要求，清晰地表达了项目的长远目标和发展方向。
- 内容结构清晰，层次分明，便于读者理解和把握项目背景。#### 问题
- 报告中提到的“智慧感控”、“全生命周期管理”等概念缺乏具体解释，可能对非专业读者造成理解困难。
- 在基于政策法规的需求部分，虽然列举了大量政策文件，但未明确指出这些政策与本项目之间的具体关联，以及如何指导项目实施。
- 缺少对当前城市燃气安全管理现状的具体描述，难以直观地感受到项目实施的紧迫性和必要性。
- 未提供足够的数据支持，如现有燃气管网的安全状况、事故率等，使得论述显得较为抽象，缺乏说服力。
#### 改进建议
- 建议在报告中加入对关键术语的定义或简要说明，以帮助不同背景的读者更好地理解项目内容。
- 对于列出的政策文件，应进一步阐明其与项目的关系及如何指导项目实施，增强论证的针对性。
- 增加对当前城市燃气安全管理现状的描述，包括存在的问题、面临的挑战等，使读者能够更直观地认识到项目的重要性。
- 补充更多具体的数据支撑，例如通过图表等形式展示现有燃气管网的安全状况、历史事故案例等，提高报告的可信度和说服力。
### 项目背景->业务及系统存在的问题
- **评分**: 78/100
- **风险等级**: 中
#### 优点
 - 详细描述了当前业务系统存在的问题，涵盖了从数据组织逻辑到智能化技术手段等多个方面。
- 明确了项目目标与现有系统的差距，指出了提升管网管理智慧化程度的必要性。
#### 问题
- 缺乏具体的数据或实例支撑问题描述，使得问题分析显得不够具体和有力。
- 在提到GIS图档不支持数据共享时，没有提供具体的解决方案或替代方案。
- 虽然提到了需要引入智能感知、人工智能等新技术，但没有明确指出如何实施这些技术，以及预期的技术路线和时间表。
#### 改进建议
- 增加具体的数据或实例来支撑问题描述，例如通过引用历史数据或案例研究来增强论点的说服力。
- 对于GIS图档不支持数据共享的问题，建议提供具体的解决方案或替代方案，如考虑使用云存储或数据脱敏技术。
- 在引入新技术的部分，应详细说明技术实施的具体步骤、预期的时间表和技术路线，以便更好地指导后续工作。
### 项目背景->预期目标
- **评分**: 80/100
- **风险等级**: 中
#### 优点
- 报告详细描述了项目预期目标，包括全生命周期管理、智慧运维模式、流程闭环和数据驱动的决策机制。
- 报告强调了基于行业标准和企业生产运营规范进行建设，符合专业规范性要求。
- 报告明确了项目的示范区选址，并结合了亦庄高级别自动驾驶示范区的战略优势，展示了项目的战略意义。
#### 问题
- 报告中提到的预期目标较为笼统，缺乏具体的数据支持和详细的实施步骤，使得目标的可实现性不够明确。
- 在构建智慧运维模式部分，虽然提到了新技术应用，但没有具体说明这些技术的具体应用场景和预期效果，缺乏足够的细节。
- 报告中关于风险识别的部分缺失，没有对可能遇到的风险进行全面客观的分析，这会影响项目的整体规划和应对措施。
#### 改进建议
- 建议在预期目标部分增加具体的数据支持和详细的实施步骤，以增强目标的可实现性和可衡量性。
- 在智慧运维模式部分，进一步细化新技术的应用场景和预期效果，提供具体的案例或试点计划，以便更好地展示技术的实际应用价值。
- 补充风险识别和应对策略的内容，对可能遇到的技术、管理、市场等方面的风险进行全面客观的分析，并提出相应的应对措施。
## 评审说明
本评审报告由AI系统生成，建议结合专家人工评审最终确定。
    """

    review_criteria_html_data = """
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>0审查意见表-前两章 - Excel 所有工作表</title>
</head>
<body>
    <div>
        <!-- 侧边栏导航 -->
        <div>
            <div>
                <h1>Excel 预览</h1>
                <div>
                    0审查意见表-前两章.xlsx
                </div>
            </div>

            <div>
                <h3>工作表导航</h3>
                <ul>
                    <li><a href="#sheet_1">1. 信息化项目方案报告审查意见</a></li>
                </ul>

                <div>
                    <h4>文件信息</h4>
                    <p>
                        <span>生成时间: 2025-12-24 15:22:42</span>
                        <span>工作表数: 1</span>
                        <span>文件: 0审查意见表-前两章.xlsx</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- 主内容区 -->
        <div>
            <div>
                <h2>Excel 工作表预览</h2>
                <div>
                    <span>文件: 0审查意见表-前两章.xlsx</span>
                    <span>生成时间: 2025-12-24 15:22:42</span>
                    <span>总工作表数: 1</span>
                </div>
            </div>

            <div id="sheet_1">
                <div>
                    <h3>1. 信息化项目方案报告审查意见</h3>
                    <div>
                        <span>转换时间: 2025-12-24 15:22:42</span>
                        <span>工作表索引: 1/1</span>
                    </div>
                </div>
                <div>
                    <table border="1">
                        <tr>
                            <td>项目名称</td>
                            <td colspan="3">&nbsp;</td>
                        </tr>
                        <tr>
                            <td>对应报告章节</td>
                            <td>审查内容</td>
                            <td>审查标准</td>
                            <td>审查问题和修改建议</td>
                        </tr>
                        <tr>
                            <td rowspan="3">1.概述</td>
                            <td>术语定义</td>
                            <td>准确</td>
                            <td>&nbsp;</td>
                        </tr>
                        <tr>
                            <td>编制依据</td>
                            <td>编制依据是否充分、有效，是否能支撑项目立项及后续建设。</td>
                            <td>&nbsp;</td>
                        </tr>
                        <tr>
                            <td>项目交流情况</td>
                            <td>交流成果是否对项目立项及后续工作有实际指导意义。</td>
                            <td>&nbsp;</td>
                        </tr>
                        <tr>
                            <td rowspan="4">2.项目背景</td>
                            <td>项目背景</td>
                            <td>1.项目背景分析是否深入、客观，是否准确反映项目建设的外部环境、行业趋势及自身需求；2.是否清晰阐述项目建设的必要性和紧迫性，能否支撑项目立项。</td>
                            <td>&nbsp;</td>
                        </tr>
                        <tr>
                            <td>业务和系统存在的问题</td>
                            <td>1.业务及系统存在的问题是否梳理全面、清晰；2.问题描述是否具体、准确，是否有数据或实例支撑；3.问题分析是否深入，能否找准问题根源，为后续解决方案提供依据。</td>
                            <td>&nbsp;</td>
                        </tr>
                        <tr>
                            <td>预期目标</td>
                            <td>1.预期目标是否明确、具体；2.预期目标是否具有可行性，是否与项目资源、技术能力等相匹配；3.预期目标是否与业务发展需求相契合，能否有效解决业务及系统存在的问题；</td>
                            <td>&nbsp;</td>
                        </tr>
                        <tr>
                            <td>项目范围</td>
                            <td>1.项目业务范围是否明确、清晰；2.项目组织范围是否明确、清晰；3.项目推广范围和深度是否明确、清晰；4.项目集成范围是否明确、清晰。</td>
                            <td>&nbsp;</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
    """
    review_topic = "安全网络可研报告评审"
    my_cfg = init_yml_cfg("/home/rd/workspace/llm_agent/apps/paper_review/cfg.yml")
    paper_reviewer = PaperReviewer(
        1,
        1,
        "可研报告评审",
        review_topic,
        "",
        "",
        "",
        my_cfg
    )
    result = paper_reviewer.fill_md_table(review_criteria_html_data, "信息化项目方案报告审查意见", single_report)
    output_file = 'formatted_report.html'
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write(result)
    logger.info(f"file output {os.path.abspath(output_file)}")



if __name__ == "__main__":
    test_fill_formatted_html_report()
