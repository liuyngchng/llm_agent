# Copyright (c) [2025] [liuyngchng@hotmail.com] - All rights reserved.

FROM ubuntu_py:24.04 as builder

WORKDIR /opt
RUN mkdir -p /opt/dm8_client
ARG PROXY=""
ARG APP="chat2db"
#ARG PROXY=" -i https://pypi.tuna.tsinghua.edu.cn/simple --trusted-host pypi.tuna.tsinghua.edu.cn"
COPY ./whl_py_dir_${APP} /tmp/whl
RUN ./llm_py_env/bin/pip install --no-cache-dir --no-index --find-links=/tmp/whl gunicorn flask \
    concurrent-log-handler langchain_openai langchain_core langchain_community \
    openai pandas tabulate pymysql oracledb dmPython sounddevice pydub pycryptodome wheel sympy markdown && \
    rm -rf /tmp/whl && \
    rm -rf ~/.cache/pip


FROM ubuntu_py:24.04
RUN bash -c 'ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime' && \
    ulimit -n 65535
COPY --from=builder /opt/llm_py_env /opt/llm_py_env

# 添加 PYTHONPATH 环境变量
ENV PYTHONPATH=/opt/app:$PYTHONPATH

# 设置达梦数据库环境变量
ENV DM_HOME=/opt/dm8_client
ENV LD_LIBRARY_PATH=/opt/dm8_client:$LD_LIBRARY_PATH

WORKDIR /opt/app

EXPOSE 19000
ENTRYPOINT ["sh", "./common/boot.sh"]
