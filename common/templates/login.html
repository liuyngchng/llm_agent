<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>{{sys_name}}</title>
    <meta charset="utf-8">
    <meta id="login.html">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="/static/crypto.js"></script>
    <link rel="stylesheet" href="/static/font-awesome.all.min.css">
    <link rel="stylesheet" href="/static/login.css">
</head>
<body>
    <div class="login-container">
        <div class="login-header">
            <div class="login-title">
                <div class="login-icon">
                    <i class="fas fa-lock"></i>
                </div>
                <div>{{sys_name}}</div>
            </div>
            <p class="login-subtitle">安全登录您的账户</p>
        </div>

        <form id="my_form" method="post" action="/login">
            <div class="form-group">
                <div class="input-icon">
                    <i class="fas fa-user"></i>
                </div>
                <input id="usr" name="usr" type="text" value="{{usr}}" placeholder="请输入用户名" autocomplete="off">
            </div>

            <div class="form-group">
                <div class="input-icon">
                    <i class="fas fa-key"></i>
                </div>
                <input id="psw" type="password" placeholder="请输入密码" value="{{psw}}" autocomplete="off">
            </div>

            <div class="captcha-group">
                <div class="captcha-container">
                    <div class="captcha-input-group">
                        <div class="captcha-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <label class="captcha-label">验证码</label>
                        <input id="captcha_code" name="captcha_code" type="text"
                               placeholder="输入4位数字" maxlength="4" autocomplete="off">
                    </div>
                    <div class="captcha-image-container" id="captcha-image-container">
                        <div id="captcha-placeholder" class="captcha-placeholder">
                            <i class="fas fa-sync-alt fa-spin"></i>
                        </div>
                    </div>
                    <button type="button" class="btn-refresh" id="refresh-captcha-btn">
                        <i class="fas fa-redo-alt"></i> 换一张
                    </button>
                </div>
            </div>

            <input id="t" name="t" type="hidden">
            <input type="hidden" name="app_source" value="{{app_source}}">
            <input type="hidden" id="captcha_token" name="captcha_token" value="{{captcha_token}}">

            <div class="btn-container">
                <button type="button" class="btn btn-primary" id="login-button">
                    <i class="fas fa-sign-in-alt"></i> 登 录
                </button>
            </div>
        </form>

        <div class="login-links">
            <a href="/reg/usr?app_source={{app_source}}" class="login-link">
                <i class="fas fa-user-plus"></i> 用户注册
            </a>
            <a href="#" class="login-link" id="forgot-password-link">
                <i class="fas fa-question-circle"></i> 忘记密码?
            </a>
            <a href="/usr/mnl?app_source={{app_source}}" target="_blank" class="login-link">
                <i class="fas fa-question-circle"></i> 帮助中心
            </a>
        </div>
        <div class="warning-message">{{warning_info}}</div>
    </div>
    <script type="text/javascript" src="/static/login.js"></script>
    <!-- 图形验证码相关脚本 -->
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function() {
            // 页面加载时加载验证码
            loadCaptcha();

            // 为换一张按钮添加事件
            document.getElementById('refresh-captcha-btn').addEventListener('click', refreshCaptcha);

            // 聚焦到用户名输入框
            const usernameInput = document.getElementById("usr");
            if (usernameInput && !usernameInput.value) {
                usernameInput.focus();
            }
            document.getElementById('forgot-password-link')?.addEventListener('click', function(e) {
                e.preventDefault();
                alert("请联系管理员");
            });
        });

        // 加载验证码
        function loadCaptcha() {
            const captchaToken = document.getElementById("captcha_token").value;
            if (!captchaToken) {
                console.error("验证码token不存在");
                return;
            }

            // 显示加载中
            const placeholder = document.getElementById("captcha-placeholder");
            const container = document.getElementById("captcha-image-container");

            if (placeholder) {
                placeholder.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i>';
                placeholder.style.display = 'flex';
            }

            // 获取验证码图片
            fetch(`/captcha/image/${captchaToken}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取验证码失败');
                    }
                    return response.text();
                })
                .then(svgContent => {
                    // 移除加载提示
                    if (placeholder) {
                        placeholder.style.display = 'none';
                    }

                    // 显示验证码图片
                    container.innerHTML = svgContent;

                    // 为SVG添加点击刷新功能
                    const svgElement = container.querySelector('svg');
                    if (svgElement) {
                        svgElement.style.cursor = 'pointer';
                        svgElement.addEventListener('click', refreshCaptcha);
                    }
                })
                .catch(error => {
                    console.error('加载验证码失败:', error);
                    if (placeholder) {
                        placeholder.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                        placeholder.style.cursor = 'pointer';
                        placeholder.addEventListener('click', refreshCaptcha);
                    }
                });
        }

        // 刷新验证码
        function refreshCaptcha() {
            // 显示加载中
            const placeholder = document.getElementById("captcha-placeholder");
            const container = document.getElementById("captcha-image-container");

            if (placeholder) {
                placeholder.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i>';
                placeholder.style.display = 'flex';
            }
            container.innerHTML = '';

            // 生成新的验证码token
            fetch('/captcha/generate')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 更新token
                        document.getElementById("captcha_token").value = data.captcha_token;

                        // 重新加载验证码
                        loadCaptcha();

                        // 清空验证码输入框
                        document.getElementById("captcha_code").value = '';
                        document.getElementById("captcha_code").focus();
                    } else {
                        alert('刷新验证码失败: ' + data.message);
                        if (placeholder) {
                            placeholder.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                        }
                    }
                })
                .catch(error => {
                    console.error('刷新验证码失败:', error);
                    alert('刷新验证码失败，请稍后重试');
                    if (placeholder) {
                        placeholder.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                    }
                });
        }

        // 验证码输入框自动跳转
        document.getElementById("captcha_code")?.addEventListener('input', function(e) {
            if (this.value.length === 4) {
                document.getElementById("login-button").focus();
            }
        });

        // 验证码输入框回车键提交
        document.getElementById("captcha_code")?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById("login-button").click();
            }
        });
    </script>
</body>
</html>