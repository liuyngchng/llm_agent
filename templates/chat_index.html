<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta id="chat_index.html">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="/static/purify.min.js"></script>
    <script type="text/javascript" src="/static/marked.min.js"></script>
    <link rel="stylesheet" href="/static/my.nl2sql.css">
    <style>
        .system-settings-link-container {
        display: flex;
        justify-content: flex-end; /* 右对齐关键属性 */
        gap: 10px; /* 按钮间距 */
        margin: 10px 0;
        }
    </style>
    <title>智能问答</title>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>智能问答</h1>
        </div>
        <div class="system-settings-link-container">
          <a href="/logout?uid={{uid}}&app_source={{app_source}}" class="system-settings-link" target="_blank">退出</a>
          <a href="/vdb/idx?uid={{uid}}&app_source={{app_source}}" class="system-settings-link" target="_blank">知识库配置</a>
        </div>
        <div class="chat-container" id="chat-container">
            <!-- 聊天内容将在这里动态生成 -->
        </div>
        
        <form id="query-form">
            <div class="input-container">
                <input type="text" class="input-field" id="query-input" name="msg" placeholder="输入你的问题，帮你深度解答" required>
                <button type="submit" class="send-button">发送</button>
            </div>
            <input type="hidden" id ="uid" name="uid" value="{{uid}}">
            <input type="hidden" id ="t" name="t" value="{{t}}">
            <input type="hidden" id ="app_source" name="app_source" value="{{app_source}}">
            <input type="hidden" id ="greeting" name="greeting" value="{{greeting}}">
        </form>
    </div>
    <div class="status-indicator" id="status-indicator"></div>
    <script>
        DOMPurify.addHook('uponSanitizeElement', (node, data) => {
            if (data.tagName === 'canvas') {
                node.setAttribute('id', data.attr.id);
            }
        });
        // 聊天容器
        const chatContainer = document.getElementById('chat-container');
        const queryForm = document.getElementById('query-form');
        const queryInput = document.getElementById('query-input');   //查询输入框
        const dbUriInput = document.getElementById('db-uri-input');
        const sendButton = document.querySelector('.send-button');  // 发送按钮
        let isFetching = false;                                     //是否正在请求数据

        window.onload = function() {
            const greetingEl = document.getElementById('greeting');
            if (greetingEl && greetingEl.value) {
                addMessage(greetingEl.value, '', '', 'bot');
            }
        };
        // 表单提交
        queryForm.addEventListener('submit', function(e) {
            try {
                e.preventDefault();
                console.log('prevent_default')
                const query = queryInput.value.trim();
                if (!query) {
                    console.log('query=' + query)
                    addMessage("请填写您想问的问题", '', '', 'bot');
                    return;
                }
                // 添加用户消息到聊天
                console.log('add_usr_msg')
                addMessage(query, 'user');

                // 清空输入框
                queryInput.value = '';
                // 发送API请求
                console.log('start_fetch')
                fetchQueryData(query).then(({response, data}) => {
                    if (!response.ok) {
                        let errorMessage = '查询失败，请稍后再试';
                        switch(response.status) {
                            case 400:
                                errorMessage = '请求参数错误，请检查您的输入';
                                break;
                            case 401:
                                errorMessage = '未授权，请重新登录';
                                break;
                            case 404:
                                errorMessage = '请求的资源不存在';
                                break;
                            case 500:
                                errorMessage = '服务器内部错误，请联系管理员';
                                break;
                            case 503:
                                errorMessage = '服务暂时不可用，请稍后再试';
                                break;
                        }
                        addMessage(errorMessage, 'bot');
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    console.log("data=" + data)
                    if (data) {
                        addMessage(data, 'bot');
                    } else {
                        addMessage("收到空响应，请重试", 'bot');
                    }
                }).catch(error => {
                    console.log("error_occurred", error.message)
                })
            } catch (error) {
                console.error("表单提交异常:", error);
                e.preventDefault(); // 双重保险
            }
        });



        // 发送API请求
        async function fetchQueryData(query) {
            console.log('fetch_data')
            let loadingMsg;
            try {
                sendButton.disabled = true;
                isFetching = true;      // 表示正在请求数据
                loadingMsg = addMessage('<div class="loading-dots">处理中</div>', 'bot');
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 300000);
                const t = document.getElementById('t').value;
                const appSource = document.getElementById('app_source').value;
                console.log('post_to_chat')
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `msg=${encodeURIComponent(query)}&uid=${encodeURIComponent(document.getElementById('uid').value)}&t=${t}&app_source=${appSource}`,
                    signal: controller.signal
                });
                const responseText = await response.text();
                if (loadingMsg && chatContainer.contains(loadingMsg)) {
                    chatContainer.removeChild(loadingMsg);
                }
                sendButton.disabled = false;
                isFetching = false;              // 数据请求完成
                if (!response.ok) throw new Error('网络响应失败');
                return {
                    response: response,
                    data: responseText
                };
            } catch (error) {
                if (loadingMsg && chatContainer.contains(loadingMsg)) {
                    chatContainer.removeChild(loadingMsg);
                }
                sendButton.disabled = false;
                throw error;
            }
        }
        function addMessage(text, type) {
            console.log("log_addMessage text=" + text);
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('message-container');

            // 安全处理内容
            const sanitizedContent = DOMPurify.sanitize(
                type === 'bot' ? marked.parse(text) : text,
                { ADD_TAGS: ['canvas'], ADD_ATTR: ['id'] }
            );

            if (type === 'user') {
                messageContainer.classList.add('user-message-container');
                messageContainer.innerHTML = `
                <div class="message-bubble user-message-bubble">${sanitizedContent}</div>`;
            } else {
                messageContainer.classList.add('bot-message-container');
                messageContainer.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                    <img width="24" height="24" src="/static/bot.png">
                    <div class="message-bubble bot-message-bubble">${sanitizedContent}</div>
                    </div>`;
            }

            chatContainer.appendChild(messageContainer);
            messageContainer.scrollIntoView({ behavior: 'smooth' });
            return messageContainer;
        }
        </script>
    </body>
</html>