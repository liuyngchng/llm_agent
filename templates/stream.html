<!DOCTYPE html>
<html>
<head>
    <title>Stream Test</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/static/my.nl2sql.css">
    <script type="text/javascript" src="/static/chart.min.3.8.0.js"></script>
</head>
<body>
    <input type="text" value="查询2024年的用户数" name="dialog" id="dialog">
    <button id="startBtn">查询</button>
    <div id="stream_output" style="margin-left:2px;"></div>

   <script>
        const outputEl = document.getElementById('stream_output');
        const startBtn = document.getElementById('startBtn');
        let eventSource = null;

        startBtn.addEventListener('click', () => {
            if (eventSource) eventSource.close();
            outputEl.innerHTML = '';
            const query = encodeURIComponent(document.getElementById('dialog').value);
            eventSource = new EventSource(`/stream?t=${Date.now()}&q=${query}`);
            eventSource.onmessage = (event) => {
                const lastChild = outputEl.lastElementChild;
                if (lastChild && (lastChild.textContent || '').includes('...')) {
                    outputEl.removeChild(lastChild);
                }
                try {
                    const { data_type, data } = JSON.parse(event.data);
                    switch(data_type) {
                        case 'txt':
                            const pre = document.createElement('pre');
                            pre.style.whiteSpace = 'pre-wrap';
                            pre.textContent = data;
                            outputEl.appendChild(pre);
                            break;

                        case 'html':
                            const html_container = document.createElement('div');
                            html_container.innerHTML = data;
                            outputEl.appendChild(html_container);
                            break;

                        case 'chart_js':
                            const chart_container = document.createElement('div');
                            chart_container.style.width = '30%';            // 宽度占父容器80%
                            chart_container.style.maxWidth = '300px';       // 最大宽度限制
                            chart_container.style.height = '300px';      // 固定高度
                            chart_container.style.margin = '20px 0 20px 10%';
                            outputEl.appendChild(chart_container);
                            const canvas = document.createElement('canvas');
                            chart_container.appendChild(canvas);

                            // 转换数据为 Chart.js 配置
                            const chartConfig = {
                                type: 'pie', // 图表类型（示例用柱状图）
                                data: {
                                    labels: data.chart.labels,
                                    datasets: [{
                                        label: `用户数 (${data.chart.unit})`, // 动态单位
                                        data: data.chart.values,
                                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                        borderColor: 'rgba(75, 192, 192, 1)',
                                        borderWidth: 1
                                    }]
                                },
                                options: { scales: { y: { beginAtZero: true } } }
                            };

                            new Chart(canvas, chartConfig); // 使用转换后的配置
                            break;

                        default:
                            console.warn('未知数据类型:', data_type);
                    }
                } catch (e) {
                    console.error('数据解析失败', e);
                    // 兼容旧格式的纯文本/HTML
                    const fallback = document.createElement('div');
                    fallback.innerHTML = event.data;
                    outputEl.appendChild(fallback);
                }
            };

            eventSource.onerror = (e) => {
                console.error("EventSource error:", e);
                eventSource.close();
            };
        });
    </script>
</body>
</html>