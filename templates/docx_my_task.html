<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线文档生成 - 我的任务</title>
    <link rel="stylesheet" href="/static/docx.my.task.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-tasks"></i> 文档生成任务</h1>
            <p>查看和管理您的文档生成任务</p>

            <div class="header-controls">
                <button class="btn btn-primary" id="refreshAllBtn">
                    <i class="fas fa-sync-alt"></i> 刷新所有任务
                </button>
            </div>
        </header>

        <div class="tasks-container">
            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
            </div>

            <table id="tasksTable">
                <thead>
                    <tr>
                        <th>文档ID</th>
                        <th>文档标题</th>
                        <th>处理信息</th>
                        <th>处理进度</th>
                        <th>文档下载</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 数据将由JavaScript动态填充 -->
                </tbody>
            </table>

            <div class="empty-state" id="emptyState" style="display: none;">
                <i class="fas fa-inbox"></i>
                <h3>暂无文档任务</h3>
                <p>您还没有创建任何文档生成任务</p>
                <a href="/docx" class="btn btn-primary">
                    <i class="fas fa-plus"></i> 创建新任务
                </a>
            </div>
        </div>
    </div>

    <script>
        // 获取任务数据
        async function fetchTasks() {
            showLoading();
            try {
                // 确保token和uid已定义
                const token = localStorage.getItem('token') || '';
<!--                const uid = localStorage.getItem('uid') || '';-->
                const uid = getUidFromUrl(); // 直接从URL获取

                const response = await fetch('/docx/my/task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ uid: uid })
                });

                if (!response.ok) throw new Error('任务获取失败');

                const tasksData = await response.json();
                const tasks = Array.isArray(tasksData) ? tasksData : [tasksData];

                renderTasksTable(tasks);
            } catch (error) {
                console.error('获取任务失败:', error);
            } finally {
                hideLoading();
            }
        }

        // 刷新单个任务状态
        async function refreshTask(taskId) {
            showLoading();

            try {
                const token = localStorage.getItem('token') || '';
                const uid = localStorage.getItem('uid') || '';

                const response = await fetch('/docx/my/task/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        uid: uid,
                        task_id: taskId
                    })
                });

                if (!response.ok) throw new Error('刷新失败');

                await fetchTasks();
            } catch (error) {
                console.error('刷新失败:', error);
                alert('刷新失败，请重试');
            }
        }

        // 重试任务
        async function retryTask(taskId) {
            showLoading();

            try {
                const token = localStorage.getItem('token') || '';
                const uid = localStorage.getItem('uid') || '';

                const response = await fetch('/docx/my/task/retry', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        uid: uid,
                        task_id: taskId
                    })
                });

                if (!response.ok) throw new Error('重试失败');

                await fetchTasks();
                alert(`任务 ${taskId} 已重新提交`);
            } catch (error) {
                console.error('重试失败:', error);
                alert('重试失败，请重试');
            }
        }

        // 渲染任务表格
        function renderTasksTable(tasks) {
            const tableBody = document.querySelector('#tasksTable tbody');
            const emptyState = document.getElementById('emptyState');

            if (!tasks || tasks.length === 0) {
                document.querySelector('table').style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            tableBody.innerHTML = '';
            tasks.forEach(task => {
                const row = document.createElement('tr');

                // 文档ID
                const idCell = document.createElement('td');
                idCell.textContent = task.task_id || '未知ID';
                idCell.style.fontWeight = '600';
                idCell.style.color = '#4b6cb7';

                // 文档标题
                const infoCell = document.createElement('td');
                infoCell.innerHTML = `
                    <div><strong>${task.doc_title || '无标题'}</strong></div>
                    <div style="color: #666; font-size: 0.9rem;">${task.doc_type || '未知类型'}</div>
                `;

                // 处理信息
                const timeCell = document.createElement('td');
                timeCell.textContent = task.process_info || '未知时间';

                // 处理进度
                const statusCell = document.createElement('td');
                statusCell.textContent = task.percent + '%';

                // 文档下载
                const downloadCell = document.createElement('td');
                downloadCell.innerHTML = `
                        <a href="/docx/download/task/{task.task_id}">
                            全文下载
                        </a>
                    `;

                // 操作
                const actionCell = document.createElement('td');
                if (task.status === 'in-progress' || task.status === 'pending') {
                    actionCell.innerHTML = `
                        <button class="action-btn action-refresh" onclick="refreshTask('${task.id}')">
                            <i class="fas fa-sync-alt"></i> 刷新状态
                        </button>
                    `;
                } else if (task.status === 'failed') {
                    actionCell.innerHTML = `
                        <button class="action-btn action-refresh" onclick="retryTask('${task.id}')">
                            <i class="fas fa-redo"></i> 重试
                        </button>
                    `;
                } else {
                    actionCell.innerHTML = `
                        <button class="action-btn" disabled>
                            <i class="fas fa-check"></i> 已完成
                        </button>
                    `;
                }

                row.appendChild(idCell);
                row.appendChild(infoCell);
                row.appendChild(timeCell);
                row.appendChild(statusCell);
                row.appendChild(downloadCell);
                row.appendChild(actionCell);
                tableBody.appendChild(row);
            });

            document.querySelector('table').style.display = 'table';
            emptyState.style.display = 'none';
        }

        // 显示加载状态
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // 隐藏加载状态
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('refreshAllBtn').addEventListener('click', fetchTasks);
            fetchTasks();
        });
        function getUidFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('uid');
        }
    </script>
</body>
</html>